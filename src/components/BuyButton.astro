---
interface Props {
  priceId: string;
  listingId: number;
  class?: string;
}

const { priceId, listingId, class: className = '' } = Astro.props;
---

<button
  class:list={['btn-primary', className]}
  data-price-id={priceId}
  data-listing-id={listingId}
  id="buy-button"
>
  Buy Now
</button>

<script>
  const button = document.getElementById('buy-button') as HTMLButtonElement;

  if (button) {
    button.addEventListener('click', async () => {
      const priceId = button.dataset.priceId;
      const listingId = button.dataset.listingId;

      button.disabled = true;
      button.textContent = 'Loading...';

      try {
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priceId, discogsListingId: listingId }),
        });

        if (!response.ok) {
          throw new Error('Checkout failed');
        }

        const { url } = await response.json();
        window.location.href = url;
      } catch (error) {
        console.error('Checkout error:', error);
        button.disabled = false;
        button.textContent = 'Buy Now';
        alert('Something went wrong. Please try again.');
      }
    });
  }
</script>
